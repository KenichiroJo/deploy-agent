# DataRobot ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆæ›¸

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ç›®çš„
DataRobotç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ãŒAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã‚’åŠ¹ç‡åŒ–ã™ã‚‹ãŸã‚ã€UIä¸Šã§è¤‡æ•°ã®ç”»é¢ã‚’è¡Œãæ¥ã™ã‚‹ä»£ã‚ã‚Šã«ã€**ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§è‡ªç„¶è¨€èªã§ç›£è¦–æƒ…å ±ã‚’ç¢ºèªãƒ»åˆ†æã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

### èƒŒæ™¯
- **èª²é¡Œ**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ç›£è¦–æƒ…å ±ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã©ï¼‰ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€DataRobot UIã§è¤‡æ•°ã®ã‚¿ãƒ–ã‚’é–‹ã„ã¦æ·±æ˜ã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€æ™‚é–“ãŒã‹ã‹ã‚‹
- **è§£æ±ºç­–**: è‡ªç„¶è¨€èªã§ã€Œæœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ã¯ï¼Ÿã€ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªåŒ–ã—ã¦ã„ã‚‹åŸå› ã¯ï¼Ÿã€ãªã©ã¨è³ªå•ã™ã‚‹ã¨ã€ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ãƒ»åˆ†æã—ã¦å›ç­”ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼**: DataRobotç¤¾å“¡ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–‹ç™ºè€…ã€MLOpsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ï¼‰
- **é–‹ç™ºç’°å¢ƒ**: DataRobot codespace

### æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§
âœ… **å®Ÿç¾å¯èƒ½** - ä»¥ä¸‹ã®DataRobot API/SDKãŒåˆ©ç”¨å¯èƒ½ï¼š
1. **OpenTelemetryãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ¬ãƒ¼ã‚¹å–å¾—**: Trace IDã€Spanæƒ…å ±ã€Input/Outputã€å®Ÿè¡Œæ™‚é–“
2. **Deployment API**: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè©³ç´°ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ç’°å¢ƒæƒ…å ±
3. **Service Stats API**: ã‚¨ãƒ©ãƒ¼ç‡ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
4. **Data Exploration API**: äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã€ãƒˆãƒ¬ãƒ¼ã‚¹å±¥æ­´ã€è©•ä¾¡çµæœ
5. **Custom Metrics API**: LLMã‚³ã‚¹ãƒˆã€ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã€ã‚«ã‚¹ã‚¿ãƒ æŒ‡æ¨™

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (React)                         â”‚
â”‚            è‡ªç„¶è¨€èªã§ã®ç›£è¦–ã‚¯ã‚¨ãƒªå…¥åŠ›                            â”‚
â”‚     ä¾‹: "deployment 698587ff ã®æœ€æ–°ã‚¨ãƒ©ãƒ¼ã‚’æ•™ãˆã¦"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ (plain text)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI Backend Server                      â”‚
â”‚                  (/chat ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ invoke({"input": "..."})
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LangGraph Agent                            â”‚
â”‚        (DeploymentMonitoringAgent - ReAct Pattern)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  System Prompt: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ         â”‚   â”‚
â”‚  â”‚  - ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æ                                       â”‚   â”‚
â”‚  â”‚  - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ºæ–­                                 â”‚   â”‚
â”‚  â”‚  - ã‚¨ãƒ©ãƒ¼èª¿æŸ»                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                     â”‚
â”‚                         â†“ (tool selection)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              MCP Tools (è‡ªå‹•çµ±åˆ)                      â”‚   â”‚
â”‚  â”‚  - get_deployment_overview                           â”‚   â”‚
â”‚  â”‚  - get_recent_traces                                 â”‚   â”‚
â”‚  â”‚  - get_service_health                                â”‚   â”‚
â”‚  â”‚  - analyze_errors                                    â”‚   â”‚
â”‚  â”‚  - get_performance_metrics                           â”‚   â”‚
â”‚  â”‚  - search_trace_by_id                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DataRobot REST API / Python SDK                 â”‚
â”‚  - Deployment API                                            â”‚
â”‚  - OpenTelemetry Trace API                                   â”‚
â”‚  - Service Stats API                                         â”‚
â”‚  - Data Exploration API                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³: ReAct + DataRobot API Integration

**é‡è¦**: ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯**LangGraphã®ReActãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

```python
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹é€  (copilot-instructions.mdæº–æ‹ )
create_react_agent(
    llm=self.llm(preferred_model="datarobot/azure/gpt-4o"),
    tools=self.mcp_tools,  # DataRobotç›£è¦–ãƒ„ãƒ¼ãƒ«ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
    prompt=make_system_prompt(system_prompt_content)
)
```

---

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### Backend & Orchestration
- **Framework**: LangGraph (`langgraph.graph.StateGraph`)
- **State**: `MessagesState` (æ¨™æº–ã®MessagesStateã‚’ä½¿ç”¨)
- **API Server**: FastAPI
- **AI Integration**: `datarobot_genai` (LLM Gatewayçµ±åˆ)
- **Tools**: Model Context Protocol (MCP) Server
- **DataRobot SDK**: `datarobot` Python Client (>= 3.11.0)

### Frontend
- **Framework**: React
- **Language**: TypeScript
- **Input**: Plain text only
- **Output**: Markdown + JSON parsing (ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã€ã‚°ãƒ©ãƒ•ã€ãƒ†ãƒ¼ãƒ–ãƒ«)

### Infrastructure
- **IaC**: Pulumi
- **Deployment**: DataRobot Custom Model Application
- **Environment**: DataRobot codespace

### é–‹ç™ºãƒ„ãƒ¼ãƒ«
- **Python**: 3.10+
- **Package Manager**: uv
- **Task Runner**: Taskfile
- **Version Control**: Git

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
datarobot-agent-application-main/
â”œâ”€â”€ agent/                                    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæœ¬ä½“
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                        # è¨­å®šç®¡ç†
â”‚   â”‚   â””â”€â”€ monitoring_agent.py              # ğŸ†• ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…
â”‚   â”œâ”€â”€ pyproject.toml
â”‚   â””â”€â”€ tests/
â”‚
â”œâ”€â”€ mcp_server/                               # MCPã‚µãƒ¼ãƒãƒ¼ (ãƒ„ãƒ¼ãƒ«å®šç¾©)
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â”œâ”€â”€ user_tools.py
â”‚   â”‚   â”‚   â”œâ”€â”€ deployment_monitoring_tools.py  # ğŸ†• ç›£è¦–ãƒ„ãƒ¼ãƒ«ç¾¤
â”‚   â”‚   â”‚   â”œâ”€â”€ user_monitoring_tools.py        # ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ãƒ„ãƒ¼ãƒ«
â”‚   â”‚   â”‚   â””â”€â”€ error_resolution_tools.py       # ğŸ†• ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ãƒ„ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ pyproject.toml
â”‚   â””â”€â”€ .env                                  # ç’°å¢ƒå¤‰æ•°è¨­å®š
â”‚
â”œâ”€â”€ fastapi_server/                           # FastAPI Backend
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â””â”€â”€ pyproject.toml
â”‚
â”œâ”€â”€ frontend_web/                             # React Frontend
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ MonitoringDashboard.tsx      # ğŸ†• ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”‚   â””â”€â”€ App.tsx
â”‚   â””â”€â”€ package.json
â”‚
â””â”€â”€ copilot-instructions.md                   # é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
```

---

## ğŸ¯ å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

### Phase 1: åŸºæœ¬ç›£è¦–æ©Ÿèƒ½ (MVP)

#### 1.1 DataRobotç›£è¦–ãƒ„ãƒ¼ãƒ«ç¾¤
**ãƒ•ã‚¡ã‚¤ãƒ«**: `mcp_server/app/tools/deployment_monitoring_tools.py`

```python
from datarobot.models import Deployment
from datarobot_genai.drmcp import dr_mcp_tool
import json
from datetime import datetime, timedelta
from typing import Optional

@dr_mcp_tool(tags={"monitoring", "deployment", "overview"})
async def get_deployment_overview(deployment_id: str) -> str:
    """
    ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®æ¦‚è¦æƒ…å ±ã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDï¼ˆä¾‹: "698587ff226830d448db7b99"ï¼‰
    
    Returns:
        ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè©³ç´°æƒ…å ±ï¼ˆJSONå½¢å¼ï¼‰
        - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã€ãƒ©ãƒ™ãƒ«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        - ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¿ã‚¤ãƒ—
        - äºˆæ¸¬ç’°å¢ƒã€ä½œæˆæ—¥æ™‚
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        overview = {
            "deployment_id": deployment.id,
            "label": deployment.label,
            "status": deployment.status,
            "description": deployment.description,
            "model_type": deployment.model.get("type"),
            "target_type": deployment.model.get("target_type"),
            "prediction_environment": {
                "id": deployment.default_prediction_server.get("id"),
                "url": deployment.default_prediction_server.get("url")
            },
            "created_at": str(deployment.created_at),
            "importance": deployment.importance
        }
        
        return json.dumps(overview, ensure_ascii=False, indent=2)
    
    except Exception as e:
        return f"ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "service", "health"})
async def get_service_health(
    deployment_id: str,
    start_time: Optional[str] = None,
    end_time: Optional[str] = None
) -> str:
    """
    ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹çµ±è¨ˆã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        start_time: é–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ã€ä¾‹: "2026-02-06T00:00:00Z"ï¼‰
        end_time: çµ‚äº†æ™‚åˆ»ï¼ˆISOå½¢å¼ã€ä¾‹: "2026-02-07T00:00:00Z"ï¼‰
    
    Returns:
        ã‚µãƒ¼ãƒ“ã‚¹çµ±è¨ˆæƒ…å ±ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ã‚¨ãƒ©ãƒ¼æ•°ã€æˆåŠŸç‡
        - å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã€P95ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
        - ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        # æ™‚åˆ»æŒ‡å®šãŒãªã„å ´åˆã¯éå»24æ™‚é–“
        if not end_time:
            end_time = datetime.utcnow()
        else:
            end_time = datetime.fromisoformat(end_time.replace('Z', '+00:00'))
        
        if not start_time:
            start_time = end_time - timedelta(hours=24)
        else:
            start_time = datetime.fromisoformat(start_time.replace('Z', '+00:00'))
        
        # ã‚µãƒ¼ãƒ“ã‚¹çµ±è¨ˆå–å¾—
        service_stats = deployment.get_service_stats(
            start=start_time,
            end=end_time
        )
        
        # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§æ•´å½¢
        total_requests = service_stats.metrics.get('totalRequests', 0)
        total_errors = service_stats.metrics.get('totalErrors', 0)
        success_rate = ((total_requests - total_errors) / total_requests * 100) if total_requests > 0 else 0
        
        health_report = f"""
## ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹: {deployment.label}

### æœŸé–“
- **é–‹å§‹**: {start_time.strftime('%Y-%m-%d %H:%M:%S UTC')}
- **çµ‚äº†**: {end_time.strftime('%Y-%m-%d %H:%M:%S UTC')}

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ±è¨ˆ
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {total_requests:,}
- **ã‚¨ãƒ©ãƒ¼æ•°**: {total_errors:,}
- **æˆåŠŸç‡**: {success_rate:.2f}%

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: {service_stats.metrics.get('avgResponseTime', 'N/A')}ms
- **P95ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: {service_stats.metrics.get('p95ResponseTime', 'N/A')}ms
- **æœ€å¤§ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: {service_stats.metrics.get('maxResponseTime', 'N/A')}ms

### ã‚¨ãƒ©ãƒ¼å†…è¨³
- **ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼**: {service_stats.metrics.get('dataErrors', 0)}
- **ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼**: {service_stats.metrics.get('systemErrors', 0)}
        """
        
        return health_report.strip()
    
    except Exception as e:
        return f"ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "trace", "agentic"})
async def get_recent_traces(
    deployment_id: str,
    limit: int = 10,
    filter_status: Optional[str] = None
) -> str:
    """
    æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”¨ï¼‰
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        limit: å–å¾—ã™ã‚‹ãƒˆãƒ¬ãƒ¼ã‚¹æ•°ï¼ˆ1-100ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰
        filter_status: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆ"success", "error", "all"ï¼‰
    
    Returns:
        ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - Trace IDã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        - å®Ÿè¡Œæ™‚é–“ã€ãƒ„ãƒ¼ãƒ«ä½¿ç”¨çŠ¶æ³
        - ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼è©³ç´°
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        # Data Explorationã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        # æ³¨: å®Ÿéš›ã®APIä»•æ§˜ã«å¿œã˜ã¦å®Ÿè£…ã‚’èª¿æ•´
        # ã“ã“ã§ã¯æ“¬ä¼¼çš„ãªå®Ÿè£…ä¾‹ã‚’ç¤ºã™
        
        trace_summary = f"""
## æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹: {deployment.label}

å–å¾—ä»¶æ•°: {limit}ä»¶
ãƒ•ã‚£ãƒ«ã‚¿: {filter_status or 'å…¨ã¦'}

### ãƒˆãƒ¬ãƒ¼ã‚¹ä¸€è¦§

| Trace ID | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Ÿè¡Œæ™‚é–“ | ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ |
|----------|--------------|----------|---------|-----------|
"""
        
        # æ³¨: å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Data Exploration API ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—
        # ä»¥ä¸‹ã¯ä¾‹ç¤º
        trace_summary += "| e8aee2e2ee9bc3f65... | 2026-02-06 15:32:33 | Success | 37192ms | LangGraph.workflow, mcp.request.tools/list |\n"
        trace_summary += "| e8aee2e2ee9bc3f65... | 2026-02-06 15:20:31 | Success | 35392ms | POST, mcp.request.initialize |\n"
        
        trace_summary += f"""
**æ³¨æ„**: è©³ç´°ãªãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€`search_trace_by_id` ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
"""
        
        return trace_summary.strip()
    
    except Exception as e:
        return f"ãƒˆãƒ¬ãƒ¼ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "trace", "detail"})
async def search_trace_by_id(
    deployment_id: str,
    trace_id: str
) -> str:
    """
    ç‰¹å®šã®Trace IDã®è©³ç´°æƒ…å ±ã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        trace_id: ãƒˆãƒ¬ãƒ¼ã‚¹IDï¼ˆä¾‹: "e8aee2e2ee9bc3f655105bd96769b7ff"ï¼‰
    
    Returns:
        ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - Spanæƒ…å ±ï¼ˆè¦ªå­é–¢ä¿‚ã€å®Ÿè¡Œé †åºï¼‰
        - å„Spanã®Input/Output
        - ã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        # OpenTelemetry APIã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°ã‚’å–å¾—
        # æ³¨: å®Ÿéš›ã®APIå®Ÿè£…ã«å¿œã˜ã¦èª¿æ•´ãŒå¿…è¦
        
        trace_detail = f"""
## ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°

**Trace ID**: `{trace_id}`
**Deployment**: {deployment.label}

### Spanéšå±¤æ§‹é€ 

```
Root Span: LangGraph.workflow [35392.37ms]
  â”œâ”€ agent.task [6815.86ms]
  â”œâ”€ POST [350.24ms]
  â”œâ”€ mcp.request.initialize [0.52ms]
  â”œâ”€ POST [60.65ms]
  â”œâ”€ POST [134.81ms]
  â””â”€ mcp.request.tools/list [0.15ms]
```

### è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| Span | å®Ÿè¡Œæ™‚é–“ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | Input/Output |
|------|---------|----------|-------------|
| LangGraph.workflow | 35392.37ms | Success | [è©³ç´°è¡¨ç¤º] |
| agent.task | 6815.86ms | Success | [è©³ç´°è¡¨ç¤º] |

**æ³¨æ„**: å®Ÿéš›ã®Input/Outputè©³ç´°ã¯DataRobot UIã®ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°ç”»é¢ã§ç¢ºèªã§ãã¾ã™ã€‚
"""
        
        return trace_detail.strip()
    
    except Exception as e:
        return f"ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "error", "analysis"})
async def analyze_errors(
    deployment_id: str,
    time_range_hours: int = 24,
    error_type: Optional[str] = None
) -> str:
    """
    ã‚¨ãƒ©ãƒ¼ã‚’åˆ†æã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„é »åº¦ã‚’ç‰¹å®š
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        time_range_hours: åˆ†æå¯¾è±¡ã®æ™‚é–“ç¯„å›²ï¼ˆæ™‚é–“å˜ä½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24ï¼‰
        error_type: ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆ"data_error", "system_error", "all"ï¼‰
    
    Returns:
        ã‚¨ãƒ©ãƒ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ã‚¨ãƒ©ãƒ¼ç·æ•°ã€ã‚¨ãƒ©ãƒ¼ç‡
        - ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®å†…è¨³
        - é »å‡ºã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        - æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=time_range_hours)
        
        # ã‚µãƒ¼ãƒ“ã‚¹çµ±è¨ˆã‹ã‚‰ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
        service_stats = deployment.get_service_stats(
            start=start_time,
            end=end_time
        )
        
        total_requests = service_stats.metrics.get('totalRequests', 0)
        total_errors = service_stats.metrics.get('totalErrors', 0)
        error_rate = (total_errors / total_requests * 100) if total_requests > 0 else 0
        
        error_report = f"""
## ã‚¨ãƒ©ãƒ¼åˆ†æ: {deployment.label}

### åˆ†ææœŸé–“
- **éå» {time_range_hours} æ™‚é–“**
- {start_time.strftime('%Y-%m-%d %H:%M')} - {end_time.strftime('%Y-%m-%d %H:%M')} UTC

### ã‚µãƒãƒªãƒ¼
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {total_requests:,}
- **ç·ã‚¨ãƒ©ãƒ¼æ•°**: {total_errors:,}
- **ã‚¨ãƒ©ãƒ¼ç‡**: {error_rate:.2f}%

### ã‚¨ãƒ©ãƒ¼å†…è¨³
- **ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼**: {service_stats.metrics.get('dataErrors', 0)} ({service_stats.metrics.get('dataErrors', 0) / total_errors * 100 if total_errors > 0 else 0:.1f}%)
- **ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼**: {service_stats.metrics.get('systemErrors', 0)} ({service_stats.metrics.get('systemErrors', 0) / total_errors * 100 if total_errors > 0 else 0:.1f}%)

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
"""
        
        # ã‚¨ãƒ©ãƒ¼ç‡ã«åŸºã¥ã„ãŸæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        if error_rate > 10:
            error_report += "âš ï¸ **é«˜ã‚¨ãƒ©ãƒ¼ç‡æ¤œå‡º** - ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™\n"
            error_report += "- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n"
            error_report += "- æœ€è¿‘ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n"
        elif error_rate > 5:
            error_report += "âš¡ **ä¸­ç¨‹åº¦ã®ã‚¨ãƒ©ãƒ¼ç‡** - ç›£è¦–ã‚’å¼·åŒ–ã—ã¦ãã ã•ã„\n"
            error_report += "- ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©³ç´°åˆ†æã—ã¦ãã ã•ã„\n"
        else:
            error_report += "âœ… **æ­£å¸¸ç¯„å›²å†…** - ç¶™ç¶šçš„ãªç›£è¦–ã‚’ç¶šã‘ã¦ãã ã•ã„\n"
        
        return error_report.strip()
    
    except Exception as e:
        return f"ã‚¨ãƒ©ãƒ¼åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "performance", "metrics"})
async def get_performance_metrics(
    deployment_id: str,
    metric_type: str = "latency",
    time_range_hours: int = 24
) -> str:
    """
    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        metric_type: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆ"latency", "throughput", "cost", "all"ï¼‰
        time_range_hours: åˆ†æå¯¾è±¡ã®æ™‚é–“ç¯„å›²ï¼ˆæ™‚é–“å˜ä½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24ï¼‰
    
    Returns:
        ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆï¼ˆå¹³å‡ã€P50ã€P95ã€P99ï¼‰
        - ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚ï¼‰
        - ã‚³ã‚¹ãƒˆæƒ…å ±ï¼ˆLLMãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãªã©ï¼‰
        - ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
    """
    try:
        deployment = Deployment.get(deployment_id=deployment_id)
        
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=time_range_hours)
        
        service_stats = deployment.get_service_stats(
            start=start_time,
            end=end_time
        )
        
        metrics_report = f"""
## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹: {deployment.label}

### åˆ†ææœŸé–“
- **éå» {time_range_hours} æ™‚é–“**

### ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆ
- **å¹³å‡**: {service_stats.metrics.get('avgResponseTime', 'N/A')}ms
- **ä¸­å¤®å€¤ (P50)**: {service_stats.metrics.get('p50ResponseTime', 'N/A')}ms
- **P95**: {service_stats.metrics.get('p95ResponseTime', 'N/A')}ms
- **P99**: {service_stats.metrics.get('p99ResponseTime', 'N/A')}ms
- **æœ€å¤§**: {service_stats.metrics.get('maxResponseTime', 'N/A')}ms

### ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {service_stats.metrics.get('totalRequests', 0):,}
- **å¹³å‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚**: {service_stats.metrics.get('totalRequests', 0) / time_range_hours:.1f}

### æ¨å¥¨äº‹é …
"""
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«åŸºã¥ã„ãŸæ¨å¥¨
        avg_latency = service_stats.metrics.get('avgResponseTime', 0)
        if avg_latency > 10000:  # 10ç§’ä»¥ä¸Š
            metrics_report += "âš ï¸ **é«˜ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¤œå‡º** - æœ€é©åŒ–ãŒå¿…è¦ã§ã™\n"
            metrics_report += "- LLMãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„\n"
            metrics_report += "- ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®ä¸¦åˆ—åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„\n"
        elif avg_latency > 5000:  # 5ç§’ä»¥ä¸Š
            metrics_report += "âš¡ **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒã‚„ã‚„é«˜ã„** - ç›£è¦–ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„\n"
        else:
            metrics_report += "âœ… **è‰¯å¥½ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**\n"
        
        return metrics_report.strip()
    
    except Exception as e:
        return f"ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
```

#### 1.2 ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `agent/agent/monitoring_agent.py`

```python
from typing import Any
from datarobot_genai.core.agents import make_system_prompt
from datarobot_genai.langgraph.agent import LangGraphAgent
from langchain_litellm.chat_models import ChatLiteLLM
from langgraph.graph import END, START, MessagesState, StateGraph
from langgraph.prebuilt import create_react_agent
from agent.config import Config

config = Config()

class DeploymentMonitoringAgent(LangGraphAgent):
    """
    DataRobotãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã«ç‰¹åŒ–ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚
    ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ºæ–­ã€ã‚¨ãƒ©ãƒ¼èª¿æŸ»ã‚’è‡ªç„¶è¨€èªã§å®Ÿè¡Œã€‚
    """

    @property
    def workflow(self) -> StateGraph[MessagesState]:
        """ã‚·ãƒ³ãƒ—ãƒ«ãªReActãƒ•ãƒ­ãƒ¼ (copilot-instructions.mdæº–æ‹ )"""
        langgraph_workflow = StateGraph[
            MessagesState, None, MessagesState, MessagesState
        ](MessagesState)
        
        langgraph_workflow.add_node("monitoring_node", self.monitoring_agent)
        langgraph_workflow.add_edge(START, "monitoring_node")
        langgraph_workflow.add_edge("monitoring_node", END)
        
        return langgraph_workflow

    @property
    def monitoring_agent(self) -> Any:
        """ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰"""
        return create_react_agent(
            self.llm(preferred_model="datarobot/azure/gpt-4o"),
            tools=self.mcp_tools,  # ç›£è¦–ãƒ„ãƒ¼ãƒ«ã‚’è‡ªå‹•å«ã‚€
            prompt=make_system_prompt(
                "ã‚ãªãŸã¯DataRobotã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚\n"
                "\n"
                "## å½¹å‰²\n"
                "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç›£è¦–ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ºæ–­ã€\n"
                "ã‚¨ãƒ©ãƒ¼èª¿æŸ»ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ãŒè¿…é€Ÿã«å•é¡Œã‚’ç‰¹å®šãƒ»è§£æ±ºã§ãã‚‹ã‚ˆã†æ”¯æ´ã—ã¾ã™ã€‚\n"
                "\n"
                "## åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«\n"
                "\n"
                "### åŸºæœ¬æƒ…å ±\n"
                "- **get_deployment_overview**: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®æ¦‚è¦æƒ…å ±ï¼ˆIDã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ç’°å¢ƒï¼‰\n"
                "\n"
                "### ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹\n"
                "- **get_service_health**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ã‚¨ãƒ©ãƒ¼ç‡ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“\n"
                "- **analyze_errors**: ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã€é »å‡ºã‚¨ãƒ©ãƒ¼ç‰¹å®š\n"
                "- **diagnose_deployment_issues**: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å•é¡Œã‚’è‡ªå‹•è¨ºæ–­\n"
                "\n"
                "### ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æ\n"
                "- **get_recent_traces**: æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ä¸€è¦§ï¼ˆæ™‚ç³»åˆ—ï¼‰\n"
                "- **search_trace_by_id**: ç‰¹å®šãƒˆãƒ¬ãƒ¼ã‚¹ã®è©³ç´°ï¼ˆSpanéšå±¤ã€Input/Outputï¼‰\n"
                "\n"
                "### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\n"
                "- **get_performance_metrics**: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ã‚³ã‚¹ãƒˆåˆ†æ\n"
                "\n"
                "### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œï¼‰\n"
                "- **get_user_usage_stats**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã®åˆ©ç”¨çµ±è¨ˆ\n"
                "- **get_all_users_summary**: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨ã‚µãƒãƒªãƒ¼\n"
                "\n"
                "### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ”¯æ´\n"
                "- **suggest_error_resolution**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ãå¯¾å‡¦æ–¹æ³•ã®ææ¡ˆ\n"
                "- **get_error_resolution_history**: éå»ã®ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦å±¥æ­´\n"
                "\n"
                "## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªã®ç†è§£\n"
                "\n"
                "### ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ„ãƒ¼ãƒ«é¸æŠ\n"
                "1. **ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’æ•™ãˆã¦ã€** â†’ `get_deployment_overview`\n"
                "2. **ã€Œæœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ã¯ï¼Ÿã€** â†’ `analyze_errors`\n"
                "3. **ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªåŒ–ã—ã¦ã„ã‚‹ã€** â†’ `get_performance_metrics` â†’ `get_service_health`\n"
                "4. **ã€Œtrace ID XXX ã®è©³ç´°ã€** â†’ `search_trace_by_id`\n"
                "5. **ã€Œä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã€** â†’ `get_recent_traces`\n"
                "6. **ã€Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã€** â†’ `get_service_health` â†’ `analyze_errors`\n"
                "7. **ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ©ç”¨çŠ¶æ³ã€** â†’ `get_user_usage_stats`\n"
                "8. **ã€Œå…¨ä½“ã®åˆ©ç”¨çŠ¶æ³ã€** â†’ `get_all_users_summary`\n"
                "9. **ã€Œã“ã®ã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦æ–¹æ³•ã¯ï¼Ÿã€** â†’ `suggest_error_resolution`\n"
                "10. **ã€Œéå»ã®ã‚¨ãƒ©ãƒ¼å±¥æ­´ã€** â†’ `get_error_resolution_history`\n"
                "11. **ã€Œå•é¡ŒãŒãªã„ã‹è¨ºæ–­ã—ã¦ã€** â†’ `diagnose_deployment_issues`\n"
                "\n"
                "### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã®æ‰±ã„\n"
                "- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«IDã‚’æŒ‡å®šã—ãŸå ´åˆ: ãã®ã¾ã¾ä½¿ç”¨\n"
                "- ã€Œã“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ã€Œç¾åœ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ¨å®š\n"
                "- IDãŒä¸æ˜ãªå ´åˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹\n"
                "\n"
                "## å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\n"
                "\n"
                "### 1. æ¦‚è¦å›ç­”ï¼ˆç°¡æ½”ã«ï¼‰\n"
                "è³ªå•ã«å¯¾ã™ã‚‹ç›´æ¥çš„ãªç­”ãˆã‚’1-2æ–‡ã§æç¤º\n"
                "\n"
                "### 2. è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆæ§‹é€ åŒ–ï¼‰\n"
                "ãƒ„ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒªã‚¹ãƒˆãªã©ï¼‰\n"
                "\n"
                "### 3. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰\n"
                "- å•é¡ŒãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ: å…·ä½“çš„ãªå¯¾å¿œæ‰‹é †\n"
                "- æ­£å¸¸ãªå ´åˆ: ç¶™ç¶šçš„ãªç›£è¦–ãƒã‚¤ãƒ³ãƒˆ\n"
                "\n"
                "### 4. é–¢é€£æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n"
                "ã•ã‚‰ã«æ·±æ˜ã‚Šã§ãã‚‹è³ªå•ä¾‹ã‚„ã€é–¢é€£ãƒ„ãƒ¼ãƒ«ã®ææ¡ˆ\n"
                "\n"
                "## é‡è¦ãªåŸå‰‡\n"
                "\n"
                "1. **ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³**: å¿…ãšãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‹ã‚‰å›ç­”\n"
                "2. **ç°¡æ½”æ€§**: å†—é•·ãªèª¬æ˜ã¯é¿ã‘ã€è¦ç‚¹ã‚’æ˜ç¢ºã«\n"
                "3. **å®Ÿç”¨æ€§**: ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ãŒå³åº§ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹æƒ…å ±ã‚’æä¾›\n"
                "4. **æ–‡è„ˆç†è§£**: éå»ã®ä¼šè©±ã‚’è€ƒæ…®ã—ã€é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ã‚’é¸æŠ\n"
                "5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã‚¨ãƒ©ãƒ¼æ™‚ã¯ã€ä»£æ›¿æ‰‹æ®µã‚’ææ¡ˆ\n"
                "\n"
                "## ä¾‹\n"
                "\n"
                "### è‰¯ã„å›ç­”ä¾‹\n"
                "```\n"
                "ãƒ¦ãƒ¼ã‚¶ãƒ¼: deployment 698587ff ã®æœ€æ–°ã‚¨ãƒ©ãƒ¼ã‚’æ•™ãˆã¦\n"
                "\n"
                "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:\n"
                "éå»24æ™‚é–“ã§12ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼ˆã‚¨ãƒ©ãƒ¼ç‡: 2.3%ï¼‰ã€‚\n"
                "\n"
                "[analyze_errors ã®çµæœã‚’è¡¨ç¤º]\n"
                "\n"
                "**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:\n"
                "ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ãŒå¤šã„ãŸã‚ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n"
                "```\n"
                "\n"
                "### é¿ã‘ã‚‹ã¹ãå›ç­”ä¾‹\n"
                "```\n"
                "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:\n"
                "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ã¾ãš... [é•·ã„èª¬æ˜]\n"
                "ä¸€èˆ¬çš„ã«ã‚¨ãƒ©ãƒ¼ã«ã¯... [ä¸€èˆ¬è«–]\n"
                "```\n"
                "\n"
                "## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼\n"
                "\n"
                "å•é¡Œå ±å‘ŠãŒã‚ã£ãŸå ´åˆã®æ¨å¥¨èª¿æŸ»é †åº:\n"
                "1. `get_deployment_overview` - åŸºæœ¬çŠ¶æ…‹ç¢ºèª\n"
                "2. `get_service_health` - å…¨ä½“çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯\n"
                "3. `analyze_errors` - ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®š\n"
                "4. `get_recent_traces` - æœ€è¿‘ã®å®Ÿè¡ŒçŠ¶æ³ç¢ºèª\n"
                "5. `search_trace_by_id` - ç‰¹å®šã‚¨ãƒ©ãƒ¼ã®è©³ç´°èª¿æŸ»\n"
                "6. `get_performance_metrics` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š"
            ),
            name="Deployment Monitoring Agent",
        )

    def llm(
        self,
        preferred_model: str | None = None,
        auto_model_override: bool = True,
    ) -> ChatLiteLLM:
        """LLMè¨­å®š (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç¶™æ‰¿)"""
        api_base = self.litellm_api_base(config.llm_deployment_id)
        model = preferred_model or config.llm_default_model
        
        if auto_model_override and not config.use_datarobot_llm_gateway:
            model = config.llm_default_model
        
        if self.verbose:
            print(f"Using model: {model}")
        
        return ChatLiteLLM(
            model=model,
            api_base=api_base,
            api_key=self.api_key,
            timeout=self.timeout,
            streaming=True,
            max_retries=3,
        )
```

### Phase 2: ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ã¨ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ææ¡ˆ

#### 2.1 ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œã®è¨­è¨ˆ

**èª²é¡Œ**: è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆé–‹ç™ºè€…ã€MLOpsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ï¼‰ãŒåŒä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã§ã®åˆ©ç”¨çŠ¶æ³ã‚’è¿½è·¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

**è§£æ±ºç­–**:
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥**: DataRobot APIã‚­ãƒ¼ã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥
2. **åˆ©ç”¨çµ±è¨ˆã®è¨˜éŒ²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ã‚¨ãƒ©ãƒ¼ç‡ã€ä½¿ç”¨ãƒ„ãƒ¼ãƒ«ã‚’è¨˜éŒ²
3. **é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã€ãƒãƒ¼ãƒ åˆ¥ã€æ™‚é–“åˆ¥ã®åˆ©ç”¨çµ±è¨ˆã‚’æä¾›

#### 2.2 ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ãƒ„ãƒ¼ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mcp_server/app/tools/user_monitoring_tools.py`

```python
from datarobot_genai.drmcp import dr_mcp_tool
from datetime import datetime, timedelta
from typing import Optional, List
import json

# æ³¨: å®Ÿé‹ç”¨ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„Redisãªã©ã®æ°¸ç¶šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
# ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ãƒ¡ãƒ¢ãƒªå†…ã«ä¿å­˜
USER_ACTIVITY_LOG = []

@dr_mcp_tool(tags={"monitoring", "user", "usage"})
async def get_user_usage_stats(
    deployment_id: str,
    user_id: Optional[str] = None,
    time_range_hours: int = 24
) -> str:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã®åˆ©ç”¨çµ±è¨ˆã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæŒ‡å®šã—ãªã„å ´åˆã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
        time_range_hours: åˆ†æå¯¾è±¡ã®æ™‚é–“ç¯„å›²ï¼ˆæ™‚é–“å˜ä½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24ï¼‰
    
    Returns:
        ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çµ±è¨ˆï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®ã‚¨ãƒ©ãƒ¼ç‡
        - ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«
        - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚é–“å¸¯
    """
    try:
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=time_range_hours)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        filtered_logs = [
            log for log in USER_ACTIVITY_LOG
            if log['deployment_id'] == deployment_id
            and start_time <= log['timestamp'] <= end_time
            and (user_id is None or log['user_id'] == user_id)
        ]
        
        if not filtered_logs:
            return f"éå»{time_range_hours}æ™‚é–“ã®åˆ©ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã«é›†è¨ˆ
        user_stats = {}
        for log in filtered_logs:
            uid = log['user_id']
            if uid not in user_stats:
                user_stats[uid] = {
                    'total_requests': 0,
                    'errors': 0,
                    'tools_used': {},
                    'queries': []
                }
            
            user_stats[uid]['total_requests'] += 1
            if log.get('error'):
                user_stats[uid]['errors'] += 1
            
            tool = log.get('tool_name', 'unknown')
            user_stats[uid]['tools_used'][tool] = user_stats[uid]['tools_used'].get(tool, 0) + 1
            user_stats[uid]['queries'].append(log.get('query', ''))
        
        # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        report = f"""
## ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çµ±è¨ˆ

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
**åˆ†ææœŸé–“**: éå» {time_range_hours} æ™‚é–“

### ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼
"""
        
        for uid, stats in user_stats.items():
            error_rate = (stats['errors'] / stats['total_requests'] * 100) if stats['total_requests'] > 0 else 0
            most_used_tool = max(stats['tools_used'].items(), key=lambda x: x[1])[0] if stats['tools_used'] else 'ãªã—'
            
            report += f"""
#### ãƒ¦ãƒ¼ã‚¶ãƒ¼: {uid}
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {stats['total_requests']}
- **ã‚¨ãƒ©ãƒ¼æ•°**: {stats['errors']}
- **ã‚¨ãƒ©ãƒ¼ç‡**: {error_rate:.1f}%
- **æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«**: {most_used_tool}
"""
        
        return report.strip()
    
    except Exception as e:
        return f"ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çµ±è¨ˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"monitoring", "user", "summary"})
async def get_all_users_summary(
    deployment_id: str,
    time_range_hours: int = 24
) -> str:
    """
    å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        time_range_hours: åˆ†æå¯¾è±¡ã®æ™‚é–“ç¯„å›²ï¼ˆæ™‚é–“å˜ä½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24ï¼‰
    
    Returns:
        å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨ã‚µãƒãƒªãƒ¼ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
        - ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
        - å¹³å‡ã‚¨ãƒ©ãƒ¼ç‡
        - äººæ°—ã®ã‚ã‚‹æ©Ÿèƒ½
    """
    try:
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=time_range_hours)
        
        filtered_logs = [
            log for log in USER_ACTIVITY_LOG
            if log['deployment_id'] == deployment_id
            and start_time <= log['timestamp'] <= end_time
        ]
        
        if not filtered_logs:
            return f"éå»{time_range_hours}æ™‚é–“ã®åˆ©ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        # å…¨ä½“çµ±è¨ˆã‚’è¨ˆç®—
        unique_users = set(log['user_id'] for log in filtered_logs)
        total_requests = len(filtered_logs)
        total_errors = sum(1 for log in filtered_logs if log.get('error'))
        
        # ãƒ„ãƒ¼ãƒ«åˆ¥ä½¿ç”¨å›æ•°
        tool_usage = {}
        for log in filtered_logs:
            tool = log.get('tool_name', 'unknown')
            tool_usage[tool] = tool_usage.get(tool, 0) + 1
        
        # äººæ°—ãƒ„ãƒ¼ãƒ«TOP3
        top_tools = sorted(tool_usage.items(), key=lambda x: x[1], reverse=True)[:3]
        
        summary = f"""
## å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨ã‚µãƒãƒªãƒ¼

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
**åˆ†ææœŸé–“**: éå» {time_range_hours} æ™‚é–“

### å…¨ä½“çµ±è¨ˆ
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: {len(unique_users)}
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {total_requests}
- **ç·ã‚¨ãƒ©ãƒ¼æ•°**: {total_errors}
- **å…¨ä½“ã‚¨ãƒ©ãƒ¼ç‡**: {(total_errors / total_requests * 100) if total_requests > 0 else 0:.1f}%

### äººæ°—æ©Ÿèƒ½ TOP3
"""
        
        for i, (tool, count) in enumerate(top_tools, 1):
            percentage = (count / total_requests * 100) if total_requests > 0 else 0
            summary += f"{i}. **{tool}**: {count}å› ({percentage:.1f}%)\n"
        
        summary += f"""
### ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†å¸ƒ
- **1-5ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: {len([u for u in unique_users if sum(1 for log in filtered_logs if log['user_id'] == u) <= 5])} ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **6-20ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: {len([u for u in unique_users if 6 <= sum(1 for log in filtered_logs if log['user_id'] == u) <= 20])} ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **21+ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: {len([u for u in unique_users if sum(1 for log in filtered_logs if log['user_id'] == u) > 20])} ãƒ¦ãƒ¼ã‚¶ãƒ¼
"""
        
        return summary.strip()
    
    except Exception as e:
        return f"å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µãƒãƒªãƒ¼ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


# ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
def log_user_activity(
    deployment_id: str,
    user_id: str,
    tool_name: str,
    query: str,
    error: bool = False,
    error_message: Optional[str] = None
):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
    
    æ³¨: å®Ÿé‹ç”¨ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„Redisãªã©ã®æ°¸ç¶šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    """
    USER_ACTIVITY_LOG.append({
        'timestamp': datetime.utcnow(),
        'deployment_id': deployment_id,
        'user_id': user_id,
        'tool_name': tool_name,
        'query': query,
        'error': error,
        'error_message': error_message
    })
    
    # ãƒ¡ãƒ¢ãƒªç®¡ç†: å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆéå»7æ—¥ä»¥ä¸Šï¼‰
    cutoff_time = datetime.utcnow() - timedelta(days=7)
    global USER_ACTIVITY_LOG
    USER_ACTIVITY_LOG = [
        log for log in USER_ACTIVITY_LOG
        if log['timestamp'] > cutoff_time
    ]
```

#### 2.3 ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ææ¡ˆãƒ„ãƒ¼ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mcp_server/app/tools/error_resolution_tools.py`

```python
from datarobot_genai.drmcp import dr_mcp_tool
from typing import Optional, Dict, List
import json

# ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®å¯¾å‡¦æ–¹æ³•ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
ERROR_RESOLUTION_DB = {
    "deployment_not_found": {
        "error_pattern": "deployment.*not found|404",
        "title": "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
        "severity": "high",
        "steps": [
            "1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„",
            "2. DataRobot UIã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª",
            "3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª",
            "4. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆå…±æœ‰è¨­å®šã‚’ç¢ºèªï¼‰"
        ],
        "prevention": [
            "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹",
            "å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®IDã‚’ä¿å­˜ã—ãªã„"
        ]
    },
    "api_authentication_error": {
        "error_pattern": "authentication|unauthorized|401|403",
        "title": "APIèªè¨¼ã‚¨ãƒ©ãƒ¼",
        "severity": "critical",
        "steps": [
            "1. ç’°å¢ƒå¤‰æ•° DATAROBOT_API_TOKEN ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª",
            "2. API keyã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèªï¼ˆDataRobot UI > API keys and toolsï¼‰",
            "3. API keyãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª",
            "4. API keyã«é©åˆ‡ãªæ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª"
        ],
        "prevention": [
            "API keyã®å®šæœŸçš„ãªãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³",
            "ç’°å¢ƒå¤‰æ•°ã®å®šæœŸç¢ºèª"
        ]
    },
    "rate_limit_exceeded": {
        "error_pattern": "rate limit|too many requests|429",
        "title": "ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é",
        "severity": "medium",
        "steps": [
            "1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦ã‚’ä¸‹ã’ã‚‹ï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•æˆ¦ç•¥ã‚’å®Ÿè£…ï¼‰",
            "2. å¿…è¦ãªå ´åˆã¯DataRobotç®¡ç†è€…ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å¼•ãä¸Šã’ã‚’ä¾é ¼",
            "3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨ã—ã¦APIå‘¼ã³å‡ºã—ã‚’å‰Šæ¸›",
            "4. ãƒãƒƒãƒå‡¦ç†ã§è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã‚‹"
        ],
        "prevention": [
            "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°å®Ÿè£…",
            "çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°"
        ]
    },
    "data_format_error": {
        "error_pattern": "invalid data|format error|schema",
        "title": "ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼",
        "severity": "medium",
        "steps": [
            "1. å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèª",
            "2. å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª",
            "3. ãƒ‡ãƒ¼ã‚¿å‹ãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆæ–‡å­—åˆ—ã€æ•°å€¤ã€æ—¥ä»˜ãªã©ï¼‰",
            "4. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚‹"
        ],
        "prevention": [
            "å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…",
            "ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã®æ–‡æ›¸åŒ–"
        ]
    },
    "timeout_error": {
        "error_pattern": "timeout|timed out",
        "title": "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼",
        "severity": "high",
        "steps": [
            "1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª",
            "2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’å»¶é•·ï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®å ´åˆï¼‰",
            "3. ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†å‰²",
            "4. DataRobotã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª"
        ],
        "prevention": [
            "é©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š",
            "å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²å‡¦ç†"
        ]
    },
    "trace_not_available": {
        "error_pattern": "trace.*not available|no trace data",
        "title": "ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“",
        "severity": "low",
        "steps": [
            "1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®šã§ãƒˆãƒ¬ãƒ¼ã‚¹æ©Ÿèƒ½ãŒæœ‰åŠ¹ã‹ç¢ºèª",
            "2. Data Explorationã§äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒæœ‰åŠ¹ã‹ç¢ºèª",
            "3. ãƒˆãƒ¬ãƒ¼ã‚¹IDãŒæ­£ã—ã„ã‹ç¢ºèª",
            "4. ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒæœŸé–“å†…ã‹ç¢ºèª"
        ],
        "prevention": [
            "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä½œæˆæ™‚ã«ãƒˆãƒ¬ãƒ¼ã‚¹æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–",
            "å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"
        ]
    }
}


@dr_mcp_tool(tags={"error", "resolution", "suggestion"})
async def suggest_error_resolution(
    error_message: str,
    deployment_id: Optional[str] = None,
    context: Optional[str] = None
) -> str:
    """
    ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦å¯¾å‡¦æ–¹æ³•ã‚’ææ¡ˆ
    
    Args:
        error_message: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¾‹: "Deployment not found"ï¼‰
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã¨ã—ã¦ä½¿ç”¨ï¼‰
        context: è¿½åŠ ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    
    Returns:
        ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ–¹æ³•ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - ã‚¨ãƒ©ãƒ¼ã®è¨ºæ–­
        - ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®å¯¾å‡¦æ‰‹é †
        - äºˆé˜²ç­–
        - é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯
    """
    try:
        import re
        
        # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°æ–‡å­—ã«å¤‰æ›ã—ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
        error_lower = error_message.lower()
        
        # ãƒãƒƒãƒã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’æ¤œç´¢
        matched_error = None
        for error_type, error_info in ERROR_RESOLUTION_DB.items():
            pattern = error_info['error_pattern']
            if re.search(pattern, error_lower):
                matched_error = error_info
                break
        
        if not matched_error:
            # æ—¢çŸ¥ã®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ãªã„å ´åˆ
            return f"""
## ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ææ¡ˆ

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: {error_message}

ã“ã®ã‚¨ãƒ©ãƒ¼ã¯æ—¢çŸ¥ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ã¾ã›ã‚“ã§ã—ãŸã€‚

### ä¸€èˆ¬çš„ãªå¯¾å‡¦æ‰‹é †
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°ã‚’ç¢ºèª
2. DataRobotã®ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆUIã¾ãŸã¯APIçµŒç”±ï¼‰
3. æœ€è¿‘ã®å¤‰æ›´ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ã‚³ãƒ¼ãƒ‰ã€ç’°å¢ƒå¤‰æ•°ï¼‰ã‚’ç¢ºèª
4. DataRobotã‚µãƒãƒ¼ãƒˆã«å•ã„åˆã‚ã›

### æ¨å¥¨ã•ã‚Œã‚‹æƒ…å ±åé›†
- å®Œå…¨ãªã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID: {deployment_id or 'N/A'}
- å®Ÿè¡Œã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°

è©³ç´°ã«ã¤ã„ã¦ã¯ã€DataRobot docsã‚’å‚ç…§ã—ã¦ãã ã•ã„:
https://docs.datarobot.com/en/docs/get-started/troubleshooting/general-help.html
"""
        
        # ãƒãƒƒãƒã—ãŸã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦æ–¹æ³•ã‚’ç”Ÿæˆ
        severity_emoji = {
            "critical": "ğŸ”´",
            "high": "ğŸŸ ",
            "medium": "ğŸŸ¡",
            "low": "ğŸŸ¢"
        }
        
        resolution = f"""
## ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ææ¡ˆ

{severity_emoji.get(matched_error['severity'], 'âšª')} **{matched_error['title']}**

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: {error_message}
**é‡è¦åº¦**: {matched_error['severity'].upper()}

### å¯¾å‡¦æ‰‹é †

"""
        
        for step in matched_error['steps']:
            resolution += f"{step}\n"
        
        resolution += f"""
### äºˆé˜²ç­–

"""
        
        for prevention in matched_error['prevention']:
            resolution += f"- {prevention}\n"
        
        # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ 
        if deployment_id:
            resolution += f"""
### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
"""
        
        if context:
            resolution += f"- **è¿½åŠ æƒ…å ±**: {context}\n"
        
        resolution += """
### é–¢é€£ãƒªã‚½ãƒ¼ã‚¹
- [DataRobot ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰](https://docs.datarobot.com/en/docs/get-started/troubleshooting/general-help.html)
- [DataRobot API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.datarobot.com/en/docs/api/reference/index.html)
- [DataRobot ã‚µãƒãƒ¼ãƒˆ](https://support.datarobot.com)
"""
        
        return resolution.strip()
    
    except Exception as e:
        return f"ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ææ¡ˆã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"error", "history", "resolution"})
async def get_error_resolution_history(
    deployment_id: str,
    time_range_hours: int = 168  # 7æ—¥é–“
) -> str:
    """
    éå»ã®ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦å±¥æ­´ã‚’å–å¾—
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
        time_range_hours: åˆ†æå¯¾è±¡ã®æ™‚é–“ç¯„å›²ï¼ˆæ™‚é–“å˜ä½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 168 = 7æ—¥ï¼‰
    
    Returns:
        ã‚¨ãƒ©ãƒ¼å¯¾å‡¦å±¥æ­´ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - é »å‡ºã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
        - åŠ¹æœçš„ã ã£ãŸå¯¾å‡¦æ–¹æ³•
        - æœªè§£æ±ºã®ã‚¨ãƒ©ãƒ¼
    """
    try:
        # æ³¨: å®Ÿé‹ç”¨ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å±¥æ­´ã‚’å–å¾—
        # ã“ã“ã§ã¯ä¾‹ç¤ºçš„ãªå®Ÿè£…
        
        from datetime import datetime, timedelta
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=time_range_hours)
        
        # USER_ACTIVITY_LOG ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æŠ½å‡ºï¼ˆå®Ÿè£…ä¾‹ï¼‰
        from user_monitoring_tools import USER_ACTIVITY_LOG
        
        error_logs = [
            log for log in USER_ACTIVITY_LOG
            if log['deployment_id'] == deployment_id
            and log.get('error')
            and start_time <= log['timestamp'] <= end_time
        ]
        
        if not error_logs:
            return f"""
## ã‚¨ãƒ©ãƒ¼å¯¾å‡¦å±¥æ­´

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
**åˆ†ææœŸé–“**: éå» {time_range_hours} æ™‚é–“

âœ… ã“ã®æœŸé–“ä¸­ã«ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
"""
        
        # ã‚¨ãƒ©ãƒ¼ã‚’ç¨®é¡åˆ¥ã«é›†è¨ˆ
        error_types = {}
        for log in error_logs:
            error_msg = log.get('error_message', 'Unknown error')
            if error_msg not in error_types:
                error_types[error_msg] = {
                    'count': 0,
                    'first_seen': log['timestamp'],
                    'last_seen': log['timestamp'],
                    'affected_users': set()
                }
            error_types[error_msg]['count'] += 1
            error_types[error_msg]['last_seen'] = max(error_types[error_msg]['last_seen'], log['timestamp'])
            error_types[error_msg]['affected_users'].add(log['user_id'])
        
        history = f"""
## ã‚¨ãƒ©ãƒ¼å¯¾å‡¦å±¥æ­´

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
**åˆ†ææœŸé–“**: éå» {time_range_hours} æ™‚é–“
**ç·ã‚¨ãƒ©ãƒ¼æ•°**: {len(error_logs)}

### é »å‡ºã‚¨ãƒ©ãƒ¼ TOP5

"""
        
        sorted_errors = sorted(error_types.items(), key=lambda x: x[1]['count'], reverse=True)[:5]
        
        for i, (error_msg, info) in enumerate(sorted_errors, 1):
            history += f"""
#### {i}. {error_msg[:100]}{'...' if len(error_msg) > 100 else ''}
- **ç™ºç”Ÿå›æ•°**: {info['count']}
- **å½±éŸ¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: {len(info['affected_users'])}
- **åˆå›ç™ºç”Ÿ**: {info['first_seen'].strftime('%Y-%m-%d %H:%M')} UTC
- **æœ€çµ‚ç™ºç”Ÿ**: {info['last_seen'].strftime('%Y-%m-%d %H:%M')} UTC

"""
        
        history += """
### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- é »å‡ºã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯ `suggest_error_resolution` ãƒ„ãƒ¼ãƒ«ã§å¯¾å‡¦æ–¹æ³•ã‚’ç¢ºèª
- åŒã˜ã‚¨ãƒ©ãƒ¼ãŒç¹°ã‚Šè¿”ã—ç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã¯æ ¹æœ¬åŸå› ã®èª¿æŸ»ãŒå¿…è¦
"""
        
        return history.strip()
    
    except Exception as e:
        return f"ã‚¨ãƒ©ãƒ¼å¯¾å‡¦å±¥æ­´ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"


@dr_mcp_tool(tags={"error", "diagnosis", "automatic"})
async def diagnose_deployment_issues(
    deployment_id: str
) -> str:
    """
    ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å•é¡Œã‚’è‡ªå‹•è¨ºæ–­
    
    Args:
        deployment_id: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID
    
    Returns:
        è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
        - æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ
        - å•é¡Œã®é‡è¦åº¦
        - æ¨å¥¨ã•ã‚Œã‚‹å¯¾å‡¦æ–¹æ³•
        - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚³ã‚¢
    """
    try:
        from datarobot.models import Deployment
        from datetime import datetime, timedelta
        
        deployment = Deployment.get(deployment_id=deployment_id)
        
        # éå»24æ™‚é–“ã®ã‚µãƒ¼ãƒ“ã‚¹çµ±è¨ˆã‚’å–å¾—
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=24)
        service_stats = deployment.get_service_stats(start=start_time, end=end_time)
        
        # å•é¡Œãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
        issues = []
        health_score = 100  # æº€ç‚¹ã¯100ç‚¹
        
        # 1. ã‚¨ãƒ©ãƒ¼ç‡ãƒã‚§ãƒƒã‚¯
        total_requests = service_stats.metrics.get('totalRequests', 0)
        total_errors = service_stats.metrics.get('totalErrors', 0)
        error_rate = (total_errors / total_requests * 100) if total_requests > 0 else 0
        
        if error_rate > 10:
            issues.append({
                'severity': 'critical',
                'issue': f'é«˜ã‚¨ãƒ©ãƒ¼ç‡ï¼ˆ{error_rate:.1f}%ï¼‰',
                'impact': 'å¤šæ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™',
                'action': 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã€åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„'
            })
            health_score -= 30
        elif error_rate > 5:
            issues.append({
                'severity': 'high',
                'issue': f'ä¸­ç¨‹åº¦ã®ã‚¨ãƒ©ãƒ¼ç‡ï¼ˆ{error_rate:.1f}%ï¼‰',
                'impact': 'ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™',
                'action': 'ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã—ã¦ãã ã•ã„'
            })
            health_score -= 15
        
        # 2. ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒã‚§ãƒƒã‚¯
        avg_latency = service_stats.metrics.get('avgResponseTime', 0)
        if avg_latency > 10000:  # 10ç§’ä»¥ä¸Š
            issues.append({
                'severity': 'high',
                'issue': f'é«˜ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆå¹³å‡ {avg_latency}msï¼‰',
                'impact': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒè‘—ã—ãæ‚ªåŒ–ã—ã¦ã„ã¾ã™',
                'action': 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãŒå¿…è¦ã§ã™'
            })
            health_score -= 20
        elif avg_latency > 5000:  # 5ç§’ä»¥ä¸Š
            issues.append({
                'severity': 'medium',
                'issue': f'ã‚„ã‚„é«˜ã„ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆå¹³å‡ {avg_latency}msï¼‰',
                'impact': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒä½ä¸‹ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
                'action': 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–ã—ã¦ãã ã•ã„'
            })
            health_score -= 10
        
        # 3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
        if deployment.status != 'active':
            issues.append({
                'severity': 'critical',
                'issue': f'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒç•°å¸¸ï¼ˆ{deployment.status}ï¼‰',
                'impact': 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã›ã‚“',
                'action': 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
            })
            health_score -= 40
        
        # è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        severity_emoji = {
            'critical': 'ğŸ”´',
            'high': 'ğŸŸ ',
            'medium': 'ğŸŸ¡',
            'low': 'ğŸŸ¢'
        }
        
        # ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã®è©•ä¾¡
        if health_score >= 90:
            health_status = 'âœ… å„ªè‰¯'
            health_color = 'ğŸŸ¢'
        elif health_score >= 70:
            health_status = 'âš ï¸ æ³¨æ„'
            health_color = 'ğŸŸ¡'
        elif health_score >= 50:
            health_status = 'âš ï¸ è­¦å‘Š'
            health_color = 'ğŸŸ '
        else:
            health_status = 'ğŸš¨ ç·Šæ€¥'
            health_color = 'ğŸ”´'
        
        report = f"""
## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ**: {deployment.label}
**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: {deployment_id}
**è¨ºæ–­æ™‚åˆ»**: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC

### ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢
{health_color} **{health_score}/100** - {health_status}

"""
        
        if issues:
            report += "### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ\n\n"
            for i, issue in enumerate(issues, 1):
                report += f"""
{severity_emoji[issue['severity']]} **å•é¡Œ {i}: {issue['issue']}**
- **é‡è¦åº¦**: {issue['severity'].upper()}
- **å½±éŸ¿**: {issue['impact']}
- **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: {issue['action']}

"""
        else:
            report += "### âœ… å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n\n"
            report += "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚ç¶™ç¶šçš„ãªç›£è¦–ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n"
        
        report += f"""
### ã‚µãƒãƒªãƒ¼çµ±è¨ˆï¼ˆéå»24æ™‚é–“ï¼‰
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {total_requests:,}
- **ã‚¨ãƒ©ãƒ¼æ•°**: {total_errors}
- **ã‚¨ãƒ©ãƒ¼ç‡**: {error_rate:.2f}%
- **å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: {avg_latency}ms

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
"""
        
        if health_score < 70:
            report += "1. ç·Šæ€¥: æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã«å¯¾å‡¦ã—ã¦ãã ã•ã„\n"
            report += "2. `analyze_errors` ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç¢ºèª\n"
            report += "3. `get_recent_traces` ãƒ„ãƒ¼ãƒ«ã§æœ€è¿‘ã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª\n"
        else:
            report += "1. ç¶™ç¶šçš„ãªç›£è¦–ã‚’ç¶šã‘ã¦ãã ã•ã„\n"
            report += "2. å®šæœŸçš„ã« `diagnose_deployment_issues` ã‚’å®Ÿè¡Œã—ã¦å¥å…¨æ€§ã‚’ç¢ºèª\n"
        
        return report.strip()
    
    except Exception as e:
        return f"ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
```

### Phase 3: é«˜åº¦åŒ–æ©Ÿèƒ½ (å°†æ¥æ‹¡å¼µ)

1. **è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**
   - ã‚¨ãƒ©ãƒ¼ç‡ãŒé–¾å€¤ã‚’è¶…ãˆãŸã‚‰é€šçŸ¥
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ã®è‡ªå‹•æ¤œå‡º

2. **ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ**
   - æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–
   - ç•°å¸¸æ¤œçŸ¥ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜

3. **æ¯”è¼ƒåˆ†æ**
   - è¤‡æ•°ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–“ã®æ¯”è¼ƒ
   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³é–“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

4. **æ ¹æœ¬åŸå› åˆ†æ**
   - ã‚¨ãƒ©ãƒ¼ã®é€£é–é–¢ä¿‚ã‚’åˆ†æ
   - ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šã®è‡ªå‹•åŒ–

---

## ğŸ“Š DataRobotç›£è¦–API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### åˆ©ç”¨å¯èƒ½ãªAPI

| API/SDK | ç”¨é€” | ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ |
|---------|------|------------|
| **Deployment API** | ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±å–å¾— | `Deployment.get()`, `Deployment.list()` |
| **Service Stats API** | ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹çµ±è¨ˆ | `deployment.get_service_stats()` |
| **Data Exploration API** | ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ | Data exploration endpoints |
| **OpenTelemetry API** | è©³ç´°ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ± | `OtelLogEntry`, `OtelMetricSummary` |
| **Custom Metrics API** | ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | Custom metrics endpoints |

### APIã‚³ãƒ¼ãƒ‰ä¾‹

```python
# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±å–å¾—
from datarobot.models import Deployment

deployment = Deployment.get(deployment_id='698587ff226830d448db7b99')
print(f"Label: {deployment.label}")
print(f"Status: {deployment.status}")

# ã‚µãƒ¼ãƒ“ã‚¹çµ±è¨ˆå–å¾—
from datetime import datetime, timedelta

end_time = datetime.utcnow()
start_time = end_time - timedelta(hours=24)

service_stats = deployment.get_service_stats(
    start=start_time,
    end=end_time
)

print(f"Total Requests: {service_stats.metrics['totalRequests']}")
print(f"Error Rate: {service_stats.metrics['errorRate']}%")
```

### ç›£è¦–ç”»é¢ã¨APIã®ãƒãƒƒãƒ”ãƒ³ã‚°

| UIç”»é¢ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ | å¯¾å¿œAPI |
|--------|------------|---------|
| **æ¦‚è¦ã‚¿ãƒ–** | ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ | `Deployment.get()` |
| **ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ > ãƒˆãƒ¬ãƒ¼ã‚¹ä¸€è¦§** | OpenTelemetry traces | Data Exploration API |
| **ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ > ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°** | Spanæƒ…å ±ã€I/O | OpenTelemetry Trace API |
| **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° > ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹** | ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ±è¨ˆ | `get_service_stats()` |
| **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° > ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹** | LLMã‚³ã‚¹ãƒˆãªã© | Custom Metrics API |

---

## âš™ï¸ ç’°å¢ƒè¨­å®š

### 1. å¿…é ˆãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

DataRobot codespaceç’°å¢ƒã§ã¯ä»¥ä¸‹ãŒãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼š
- Python 3.10+
- uv (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼)
- Taskfile (ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼)
- Pulumi (IaC)
- Git

### 2. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

#### MCPã‚µãƒ¼ãƒãƒ¼ä¾å­˜é–¢ä¿‚è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mcp_server/pyproject.toml`

```toml
[project]
dependencies = [
    # ... æ—¢å­˜ã®ä¾å­˜é–¢ä¿‚
    "datarobot>=3.11.0",  # ğŸ†• DataRobot Python SDK
]
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ï¼š
```bash
cd mcp_server
uv pip install datarobot
```

### 3. ç’°å¢ƒå¤‰æ•°è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mcp_server/.env`

```bash
# å¿…é ˆ: DataRobotèªè¨¼æƒ…å ±
DATAROBOT_API_TOKEN=[YOUR_DATAROBOT_API_KEY]
DATAROBOT_ENDPOINT=[YOUR_DATAROBOT_ENDPOINT]

# å¿…é ˆ: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç§˜å¯†éµ
SESSION_SECRET_KEY=[YOUR_SESSION_SECRET_KEY]

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ã‚µãƒ¼ãƒãƒ¼è¨­å®š
MCP_SERVER_NAME=datarobot-monitoring-mcp
MCP_SERVER_PORT=8080
MCP_SERVER_LOG_LEVEL=WARNING
APP_LOG_LEVEL=INFO

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³: å‹•çš„ãƒ„ãƒ¼ãƒ«ç™»éŒ²
MCP_SERVER_REGISTER_DYNAMIC_TOOLS_ON_STARTUP=true

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³: MCP target_typeè¨­å®š
USE_MCP_TARGET_TYPE=true
```

---

## ğŸ”‘ é‡è¦ãªè¨­è¨ˆåŸå‰‡

### copilot-instructions.md æº–æ‹ 

#### 1. Stateç®¡ç†
```python
# âœ… Good: æ¨™æº–ã®MessagesStateã‚’ä½¿ç”¨
StateGraph[MessagesState, None, MessagesState, MessagesState](MessagesState)
```

#### 2. å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
```python
# âœ… Good: ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
invoke({"input": "deployment 698587ff ã®ã‚¨ãƒ©ãƒ¼åˆ†æ"})
```

#### 3. MCPãƒ„ãƒ¼ãƒ«å®šç¾©
```python
# âœ… Good: @dr_mcp_toolãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨
@dr_mcp_tool(tags={"monitoring", "trace"})
async def get_recent_traces(deployment_id: str, limit: int = 10) -> str:
    """æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—"""
    pass
```

#### 4. LLMå‘¼ã³å‡ºã—
```python
# âœ… Good: self.llm()ã‚’ä½¿ç”¨
self.llm(preferred_model="datarobot/azure/gpt-4o")
```

#### 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```python
# âœ… Good: ä¸å¯§ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
try:
    deployment = Deployment.get(deployment_id=deployment_id)
except Exception as e:
    return f"ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
```

---

## ğŸš€ é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

#### 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
```bash
git clone [repository-url]
cd datarobot-agent-application-main
```

#### 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
task install
```

#### 3. MCPã‚µãƒ¼ãƒãƒ¼èµ·å‹•
```bash
cd mcp_server
task run
```

#### 4. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
```bash
cd agent
task dev
```

#### 5. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# ç›£è¦–ãƒ„ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ
cd mcp_server
pytest app/tests/test_deployment_monitoring_tools.py

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
cd agent
pytest tests/test_monitoring_agent.py
```

### ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# PulumiçµŒç”±ã§DataRobotã«ãƒ‡ãƒ—ãƒ­ã‚¤
cd infra
pulumi up
```

---

## ğŸ¯ å®Ÿè£…ã®å„ªå…ˆé †ä½

### Phase 1: MVP (åŸºæœ¬ç›£è¦–æ©Ÿèƒ½)
**æœŸé–“**: 2-3æ—¥

- [x] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆæ›¸ä½œæˆ
- [ ] ç›£è¦–ãƒ„ãƒ¼ãƒ«å®Ÿè£… (`deployment_monitoring_tools.py`)
  - [ ] `get_deployment_overview`
  - [ ] `get_service_health`
  - [ ] `get_recent_traces`
  - [ ] `analyze_errors`
- [ ] ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£… (`monitoring_agent.py`)
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š (`.env`)
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œç¢ºèª

**æˆåŠŸæ¡ä»¶**: 
- "deployment XXX ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯" ã§çµ±è¨ˆæƒ…å ±ãŒè¿”ã‚‹
- ã‚¨ãƒ©ãƒ¼åˆ†æãŒå®Ÿè¡Œã§ãã‚‹
- ãƒˆãƒ¬ãƒ¼ã‚¹ä¸€è¦§ãŒå–å¾—ã§ãã‚‹

### Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ã¨ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ©Ÿèƒ½
**æœŸé–“**: 3-4æ—¥

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ãƒ„ãƒ¼ãƒ«å®Ÿè£… (`user_monitoring_tools.py`)
  - [ ] `get_user_usage_stats`
  - [ ] `get_all_users_summary`
  - [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°æ©Ÿèƒ½
- [ ] ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ãƒ„ãƒ¼ãƒ«å®Ÿè£… (`error_resolution_tools.py`)
  - [ ] `suggest_error_resolution`
  - [ ] `get_error_resolution_history`
  - [ ] `diagnose_deployment_issues`
- [ ] ã‚¨ãƒ©ãƒ¼å¯¾å‡¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å……å®ŸåŒ–
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ

**æˆåŠŸæ¡ä»¶**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®åˆ©ç”¨çµ±è¨ˆãŒæ­£ç¢ºã«å–å¾—ã§ãã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é©åˆ‡ãªå¯¾å‡¦æ–¹æ³•ãŒææ¡ˆã•ã‚Œã‚‹
- è‡ªå‹•è¨ºæ–­ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å•é¡ŒãŒæ¤œå‡ºã§ãã‚‹

### Phase 3: ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
**æœŸé–“**: 2-3æ—¥

- [ ] `search_trace_by_id` å®Ÿè£…
- [ ] OpenTelemetry APIçµ±åˆ
- [ ] Spanéšå±¤ã®å¯è¦–åŒ–
- [ ] Input/Outputè©³ç´°è¡¨ç¤º
- [ ] `get_performance_metrics` å®Ÿè£…
- [ ] ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆã®è¨ˆç®—
- [ ] ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†ææ©Ÿèƒ½
- [ ] ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šæ”¯æ´

**æˆåŠŸæ¡ä»¶**:
- Trace IDã‚’æŒ‡å®šã—ã¦è©³ç´°æƒ…å ±ãŒå–å¾—ã§ãã‚‹
- Spanéšå±¤ãŒç†è§£ã—ã‚„ã™ã„å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ã‚’è‡ªå‹•æ¤œå‡ºã§ãã‚‹
- æ¨å¥¨ã•ã‚Œã‚‹æœ€é©åŒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæç¤ºã•ã‚Œã‚‹

### Phase 4: çµ±åˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤
**æœŸé–“**: 2-3æ—¥

- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨ã®çµ±åˆ
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ã®æ°¸ç¶šåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
- [ ] E2Eãƒ†ã‚¹ãƒˆ
- [ ] DataRobotã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
- [ ] é‹ç”¨ã‚¬ã‚¤ãƒ‰ä½œæˆ

---

## ğŸ“ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã®æ³¨æ„ç‚¹

### Do's âœ…

1. **DataRobot SDK ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   ```python
   try:
       deployment = Deployment.get(deployment_id=deployment_id)
   except dr.errors.ClientError as e:
       if e.status_code == 404:
           return f"ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID {deployment_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
       else:
           return f"API ã‚¨ãƒ©ãƒ¼: {str(e)}"
   ```

2. **æ™‚åˆ»å‡¦ç†ã®çµ±ä¸€**
   ```python
   from datetime import datetime, timezone
   
   # å¸¸ã«UTCã‚’ä½¿ç”¨
   end_time = datetime.now(timezone.utc)
   ```

3. **å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†**
   ```python
   # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…
   async def get_all_traces(deployment_id: str, limit: int = 100):
       offset = 0
       all_traces = []
       while len(all_traces) < limit:
           batch = fetch_traces(offset=offset, batch_size=20)
           if not batch:
               break
           all_traces.extend(batch)
           offset += 20
       return all_traces[:limit]
   ```

4. **ãƒ„ãƒ¼ãƒ«çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥**
   ```python
   from functools import lru_cache
   
   @lru_cache(maxsize=128)
   def get_deployment_info_cached(deployment_id: str):
       return Deployment.get(deployment_id=deployment_id)
   ```

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ã¨ãƒ­ã‚°è¨˜éŒ²**
   ```python
   # FastAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
   from fastapi import Request
   
   async def get_current_user(request: Request) -> str:
       # DataRobot API keyã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰è­˜åˆ¥
       api_key = request.headers.get("Authorization")
       # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
       return user_id
   
   # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
   from user_monitoring_tools import log_user_activity
   
   log_user_activity(
       deployment_id=deployment_id,
       user_id=user_id,
       tool_name="get_service_health",
       query=user_query,
       error=False
   )
   ```

6. **ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ï¼ˆæœ¬ç•ªé‹ç”¨ï¼‰**
   ```python
   # é–‹ç™ºæ™‚: ãƒ¡ãƒ¢ãƒªå†…ãƒªã‚¹ãƒˆ
   USER_ACTIVITY_LOG = []
   
   # æœ¬ç•ªæ™‚: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgreSQLã€MongoDBç­‰ï¼‰ã¾ãŸã¯Redis
   import redis
   r = redis.Redis(host='localhost', port=6379, db=0)
   
   def log_activity_to_redis(activity_data):
       key = f"activity:{activity_data['deployment_id']}:{activity_data['timestamp']}"
       r.setex(key, 86400*7, json.dumps(activity_data))  # 7æ—¥é–“ä¿æŒ
   ```

### Don'ts âŒ

1. **èªè¨¼æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰**
   ```python
   # âŒ Bad
   api_key = "abc123..."
   
   # âœ… Good
   api_key = os.getenv("DATAROBOT_API_TOKEN")
   ```

2. **åŒæœŸé–¢æ•°ã¨éåŒæœŸé–¢æ•°ã®æ··åœ¨**
   ```python
   # MCPãƒ„ãƒ¼ãƒ«ã¯å¿…ãšasync
   @dr_mcp_tool(tags={"monitoring"})
   async def my_tool(arg: str) -> str:  # âœ…
       pass
   ```

3. **ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™**
   ```python
   # âŒ Bad
   return str(service_stats)  # ç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   
   # âœ… Good
   return json.dumps(service_stats.metrics, indent=2)  # æ•´å½¢æ¸ˆã¿JSON
   ```

---

## ğŸ“š å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [DataRobot Agentic AI Monitoring](https://docs.datarobot.com/en/docs/agentic-ai/agentic-eval/agentic-tracing.html)
- [DataRobot Python SDK - Deployments](https://datarobot-public-api-client.readthedocs-hosted.com/en/early-access/reference/mlops/deployment.html)
- [OpenTelemetry Tracing](https://docs.datarobot.com/en/docs/agentic-ai/agentic-eval/agentic-tracing.html)
- [DataRobot Service Stats API](https://docs.datarobot.com/en/docs/api/reference/sdk/deployment-management.html)

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–¢é€£
- `copilot-instructions.md`: é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¨åˆ¶ç´„äº‹é …
- `README.md`: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨åŸºæœ¬çš„ãªä½¿ã„æ–¹
- `mcp_server/README.md`: MCPã‚µãƒ¼ãƒãƒ¼è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### å†…éƒ¨æ§‹é€ 
- `agent/agent/myagent.py`: ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…
- `mcp_server/app/tools/user_tools.py`: ãƒ„ãƒ¼ãƒ«å®šç¾©ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

---

## ğŸ’¡ ä½¿ç”¨ä¾‹

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªä¾‹ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œ

#### ä¾‹1: åŸºæœ¬çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: deployment 698587ff ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã—ã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[get_deployment_overview å®Ÿè¡Œ]
[get_service_health å®Ÿè¡Œ]

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ "[agent-0206-kj] [agent] Deployment" ã¯æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ï¼ˆéå»24æ™‚é–“ï¼‰
- ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: 1,234
- ã‚¨ãƒ©ãƒ¼æ•°: 12
- æˆåŠŸç‡: 99.0%
- å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 3,521ms

âœ… å…¨ä½“çš„ã«è‰¯å¥½ãªçŠ¶æ…‹ã§ã™ã€‚
```

#### ä¾‹2: ã‚¨ãƒ©ãƒ¼èª¿æŸ»
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: æœ€è¿‘ã‚¨ãƒ©ãƒ¼ãŒå¢—ãˆã¦ã‚‹æ°—ãŒã™ã‚‹ã€‚èª¿ã¹ã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[analyze_errors å®Ÿè¡Œ]

éå»24æ™‚é–“ã§23ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼ˆå‰æ—¥æ¯”+92%ï¼‰ã€‚

## ã‚¨ãƒ©ãƒ¼å†…è¨³
- ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: 18ä»¶ (78%)
- ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: 5ä»¶ (22%)

âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ãŒæ€¥å¢—ã—ã¦ã„ã¾ã™ã€‚

**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãŒãªã„ã‹ç¢ºèª
2. æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã§Inputå½¢å¼ã‚’ç¢ºèª
3. `get_recent_traces` ã§è©³ç´°èª¿æŸ»ã‚’æ¨å¥¨
```

#### ä¾‹3: ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°èª¿æŸ»
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: trace e8aee2e2ee9bc3f655105bd96769b7ff ã®è©³ç´°ã‚’è¦‹ã›ã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[search_trace_by_id å®Ÿè¡Œ]

## ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°

**Trace ID**: e8aee2e2ee9bc3f655105bd96769b7ff
**å®Ÿè¡Œæ™‚é–“**: 37,192ms
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Success

### Spanéšå±¤
```
LangGraph.workflow [35392ms]
  â”œâ”€ agent.task [6815ms]
  â”œâ”€ mcp.request.initialize [0.52ms]
  â””â”€ mcp.request.tools/list [0.15ms]
```

**æ³¨æ„**: agent.taskã®å®Ÿè¡Œæ™‚é–“ãŒé•·ã„ã§ã™ã€‚
ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®æœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
```

#### ä¾‹4: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çŠ¶æ³ã®ç¢ºèª
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: deployment 698587ff ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®åˆ©ç”¨çŠ¶æ³ã‚’æ•™ãˆã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[get_user_usage_stats å®Ÿè¡Œ]

## ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çµ±è¨ˆ

**åˆ†ææœŸé–“**: éå» 24 æ™‚é–“

### ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼: alice@datarobot.com
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: 45
- **ã‚¨ãƒ©ãƒ¼æ•°**: 2
- **ã‚¨ãƒ©ãƒ¼ç‡**: 4.4%
- **æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«**: get_service_health

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼: bob@datarobot.com
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: 23
- **ã‚¨ãƒ©ãƒ¼æ•°**: 0
- **ã‚¨ãƒ©ãƒ¼ç‡**: 0.0%
- **æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«**: analyze_errors

å…¨ä½“çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåˆ©ç”¨ãŒç¢ºèªã§ãã¾ã™ã€‚
```

#### ä¾‹5: ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ–¹æ³•ã®ææ¡ˆ
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "Deployment not found" ã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[suggest_error_resolution å®Ÿè¡Œ]

ğŸŸ  **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“**

**é‡è¦åº¦**: HIGH

### å¯¾å‡¦æ‰‹é †

1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„
2. DataRobot UIã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
4. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆå…±æœ‰è¨­å®šã‚’ç¢ºèªï¼‰

### äºˆé˜²ç­–

- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹
- å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®IDã‚’ä¿å­˜ã—ãªã„

### é–¢é€£ãƒªã‚½ãƒ¼ã‚¹
- [DataRobot ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰](https://docs.datarobot.com/...)
```

#### ä¾‹6: è‡ªå‹•è¨ºæ–­
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: deployment 698587ff ã«å•é¡ŒãŒãªã„ã‹è¨ºæ–­ã—ã¦

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
[diagnose_deployment_issues å®Ÿè¡Œ]

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

### ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢
ğŸŸ¢ **92/100** - âœ… å„ªè‰¯

### âœ… å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚ç¶™ç¶šçš„ãªç›£è¦–ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### ã‚µãƒãƒªãƒ¼çµ±è¨ˆï¼ˆéå»24æ™‚é–“ï¼‰
- **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: 1,234
- **ã‚¨ãƒ©ãƒ¼æ•°**: 12
- **ã‚¨ãƒ©ãƒ¼ç‡**: 0.97%
- **å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 3,521ms

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ç¶™ç¶šçš„ãªç›£è¦–ã‚’ç¶šã‘ã¦ãã ã•ã„
2. å®šæœŸçš„ã« `diagnose_deployment_issues` ã‚’å®Ÿè¡Œã—ã¦å¥å…¨æ€§ã‚’ç¢ºèª
```

---

## ğŸ¤ é–‹ç™ºæ”¯æ´ã®ãŸã‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

### ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€LLMãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒ**DataRobotãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®Œå…¨ã«ç†è§£ã—ã€é©åˆ‡ãªã‚³ãƒ¼ãƒ‰ææ¡ˆã‚’è¡Œãˆã‚‹**ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### LLMã«æœŸå¾…ã™ã‚‹æ”¯æ´å†…å®¹

1. **ç›£è¦–ãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…**
   - DataRobot APIçµ±åˆ
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ã®å‡ºåŠ›æ•´å½¢

2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®æœ€é©åŒ–**
   - é©åˆ‡ãªãƒ„ãƒ¼ãƒ«é¸æŠ
   - åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—
   - ã‚ã‹ã‚Šã‚„ã™ã„å›ç­”ç”Ÿæˆ

3. **ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ**
   - å˜ä½“ãƒ†ã‚¹ãƒˆ
   - çµ±åˆãƒ†ã‚¹ãƒˆ
   - ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ

4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ**
   - APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### è³ªå•ã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- DataRobotç¤¾å†…Slackãƒãƒ£ãƒ³ãƒãƒ«
- [DataRobot Support](https://docs.datarobot.com/en/docs/get-started/troubleshooting/general-help.html)

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
1. DataRobot APIèªè¨¼ã‚¨ãƒ©ãƒ¼
   - ç’°å¢ƒå¤‰æ•° `DATAROBOT_API_TOKEN` ã‚’ç¢ºèª
   - API keyã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèª

2. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDå–å¾—ã‚¨ãƒ©ãƒ¼
   - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   - ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª

3. ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„
   - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã§ãƒˆãƒ¬ãƒ¼ã‚¹æ©Ÿèƒ½ãŒæœ‰åŠ¹ã‹ç¢ºèª
   - Data Explorationã§äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

**æœ€çµ‚æ›´æ–°**: 2026-02-06  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0  
**ä½œæˆè€…**: DataRobot Agent Development Team
